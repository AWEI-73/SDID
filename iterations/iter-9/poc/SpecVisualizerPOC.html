<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Blueprint - Visualizer</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Mermaid -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

    <style>
        /* GEMS Control Tower Theme Matching */
        body {
            font-family: 'Inter', system-ui, sans-serif;
            @apply bg-slate-50 text-slate-600;
        }

        /* Tree Node */
        .tree-node {
            @apply flex items-center gap-3 px-3 py-2 text-sm text-slate-600 rounded-lg cursor-pointer transition-all duration-200 border border-transparent;
        }

        .tree-node:hover {
            @apply bg-slate-100;
        }

        .tree-node.active {
            @apply bg-blue-50 text-blue-700 font-semibold border-blue-100 shadow-sm;
        }

        .tree-node .icon {
            @apply w-4 h-4 text-slate-400 transition-colors;
        }

        .tree-node.active .icon {
            @apply text-blue-600;
        }

        /* Detail Cards */
        .detail-card {
            @apply bg-white border border-slate-200 rounded-xl p-6 shadow-sm mb-6 transition-all;
        }

        .detail-card:hover {
            @apply shadow-md border-slate-300;
        }

        .detail-header {
            @apply flex items-center gap-3 mb-5 pb-4 border-b border-slate-100;
        }

        .detail-title {
            @apply font-bold text-slate-800 text-lg;
        }

        /* Flow Pills */
        .flow-pill {
            @apply inline-flex items-center px-2.5 py-1 rounded-md text-xs font-medium bg-slate-100 text-slate-600 border border-slate-200 mr-2 mb-2 transition-colors;
        }

        .flow-pill:hover {
            @apply bg-slate-200 border-slate-300;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            @apply bg-slate-200 rounded-full;
        }

        ::-webkit-scrollbar-thumb:hover {
            @apply bg-slate-300;
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header (Matching Control Tower) -->
    <header
        class="bg-white border-b border-slate-200 px-6 h-16 flex justify-between items-center shrink-0 z-10 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="bg-gradient-to-br from-blue-600 to-indigo-600 p-2 rounded-lg shadow-blue-200 shadow-lg">
                <i data-lucide="layers" class="w-5 h-5 text-white"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold text-slate-800 tracking-tight">System Blueprint</h1>
                <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Visualizer POC</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <span
                class="px-2 py-1 bg-green-50 border border-green-100 text-green-700 text-xs rounded-full font-medium flex items-center gap-1">
                <i data-lucide="power" class="w-3 h-3"></i> Active
            </span>
        </div>
    </header>

    <div class="flex flex-1 min-h-0">

        <!-- Sidebar -->
        <aside class="w-72 bg-white border-r border-slate-200 flex flex-col shrink-0">
            <div class="p-4 border-b border-slate-100">
                <div class="relative group">
                    <i data-lucide="search"
                        class="absolute left-3 top-2.5 w-4 h-4 text-slate-400 group-focus-within:text-blue-500 transition-colors"></i>
                    <input type="text" placeholder="Search nodes..."
                        class="w-full bg-slate-50 border border-slate-200 rounded-lg pl-9 pr-3 py-2 text-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-400 outline-none transition-all placeholder:text-slate-400">
                </div>
            </div>

            <div id="tree-root" class="flex-1 overflow-y-auto p-3 space-y-1">
                <!-- Tree Content -->
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto bg-slate-50/50 p-8 relative">
            <div id="detail-view" class="max-w-5xl mx-auto pb-10">
                <!-- Empty State -->
            </div>
        </main>
    </div>

    <script>
        /**
         * @GEMS-CONTRACT: SystemNode
         * @GEMS-DESC: 系統藍圖節點結構 (Recursive)
         * @GEMS-TYPE: Interface
         * @property {string} name - 節點名稱
         * @property {string} type - project | database | module | script | function
         * @property {SystemNode[]} children - 子節點
         * @property {SystemNode[]} scripts - 腳本列表
         * @property {FunctionNode[]} functions - 函式/零件
         */

        // Mock Data (Same as before)
        const SYSTEM_DATA = {
            name: "GEMS Control Tower",
            type: "project",
            stats: { modules: 7, scripts: 50, functions: 17, tables: 4 },
            config: { constants: ["ENV", "APP_RULES"], hardcoded: 13 },
            children: [
                {
                    name: "Database",
                    type: "database",
                    desc: "PostgreSQL Schema",
                    tables: [
                        { name: "tbl_inventory", desc: "庫存主表", columns: [{ name: "id", type: "UUID", flags: ["PK"] }, { name: "sku", type: "VARCHAR", flags: ["UQ"] }, { name: "qty", type: "INT", flags: ["NN"] }] },
                        { name: "tbl_transactions", desc: "交易紀錄", columns: [{ name: "id", type: "UUID", flags: ["PK"] }, { name: "type", type: "VARCHAR", flags: [] }] }
                    ],
                    erDiagram: `erDiagram
          tbl_inventory ||--o{ tbl_transactions : has`
                },
                {
                    name: "Source Modules",
                    type: "folder",
                    desc: "Business Logic Modules",
                    children: [
                        {
                            name: "inventory",
                            type: "module",
                            desc: "庫存管理",
                            scripts: [
                                {
                                    name: "inventory.service.ts",
                                    type: "script",
                                    path: "src/modules/inventory/inventory.service.ts",
                                    functions: [
                                        { name: "adjustStock", type: "function", tag: "P0", desc: "庫存調整 (增/減)", flow: ["CheckCurrentStock", "ValidateNonNegative", "UpsertDB", "Return"] }
                                    ]
                                }
                            ]
                        },
                        {
                            name: "operations",
                            type: "module",
                            desc: "營運操作",
                            scripts: [
                                {
                                    name: "checkout.service.ts",
                                    type: "script",
                                    path: "src/modules/operations/checkout.service.ts",
                                    functions: [
                                        { name: "processCheckout", type: "function", tag: "P0", desc: "領用流程", flow: ["DetermineType", "Asset?UpdateStatus", "LogTransaction"] }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                {
                    name: "Global Config",
                    type: "config-group",
                    desc: "Application Settings",
                    scripts: [{ name: "env.ts", type: "script", functions: [{ name: "ENV", type: "const", desc: "Schema Validation", val: "z.object" }] }]
                }
            ]
        };

        // Renderers (Styled)
        function renderTree(node, level = 0, container) {
            if (!node) return;
            let icon = 'box';
            if (node.type === 'project') icon = 'layout-grid';
            else if (node.type === 'database') icon = 'database';
            else if (node.type === 'folder') icon = 'folder';
            else if (node.type === 'module') icon = 'package';
            else if (node.type === 'script') icon = 'file-code';
            else if (node.type === 'config-group') icon = 'settings';

            const item = document.createElement('div');
            const indent = level * 16;
            item.className = 'tree-node';
            item.style.paddingLeft = level === 0 ? '12px' : `${indent + 12}px`;

            item.innerHTML = `
        <i data-lucide="${icon}" class="icon shrink-0"></i>
        <span class="truncate font-medium">${node.name}</span>
    `;

            item.addEventListener('click', (e) => {
                document.querySelectorAll('.tree-node').forEach(el => el.classList.remove('active'));
                item.classList.add('active');
                renderDetail(node);
                e.stopPropagation();
            });

            container.appendChild(item);

            // Recursion
            const renderChildren = (list) => { if (list) list.forEach(c => renderTree(c, level + 1, container)); };
            renderChildren(node.children);
            renderChildren(node.scripts);
        }

        function renderDetail(node) {
            const container = document.getElementById('detail-view');

            // Header
            let html = `
        <div class="mb-8">
            <div class="flex items-center gap-2 text-xs text-blue-600 font-bold uppercase tracking-wider mb-2">
                <span class="bg-blue-50 px-2 py-0.5 rounded border border-blue-100">${node.type}</span>
                ${node.path ? `<span class="text-slate-400 font-normal normal-case font-mono">${node.path}</span>` : ''}
            </div>
            <h2 class="text-3xl font-bold text-slate-900 tracking-tight mb-2">${node.name}</h2>
            ${node.desc ? `<p class="text-lg text-slate-500">${node.desc}</p>` : ''}
        </div>
    `;

            // Content
            if (node.type === 'project') html += renderProjectStats(node);
            else if (node.type === 'database') html += renderDatabaseContent(node);
            else if (node.type === 'script') html += renderScriptContent(node);

            container.innerHTML = html;
            lucide.createIcons();
            if (node.erDiagram) { mermaid.initialize({ startOnLoad: false }); mermaid.run(); }
        }

        function renderProjectStats(node) {
            return `
        <div class="grid grid-cols-4 gap-4 mb-8">
            ${Object.entries(node.stats).map(([k, v]) => `
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex flex-col">
                    <span class="text-xs text-slate-400 font-bold uppercase mb-1">${k}</span>
                    <span class="text-3xl font-bold text-slate-800">${v}</span>
                </div>
            `).join('')}
        </div>
        <div class="detail-card">
            <div class="detail-header"><i data-lucide="alert-triangle" class="w-5 h-5 text-amber-500"></i><span class="detail-title">System Health</span></div>
            <div class="bg-amber-50 border border-amber-100 text-amber-800 p-4 rounded-lg text-sm flex items-center gap-3">
                <i data-lucide="alert-circle" class="w-5 h-5"></i>
                Found <strong>${node.config.hardcoded}</strong> hardcoded values in configuration.
            </div>
        </div>
    `;
        }

        function renderDatabaseContent(node) {
            return `
        <div class="detail-card">
            <div class="detail-header"><i data-lucide="git-fork" class="w-5 h-5 text-indigo-500"></i><span class="detail-title">Relationship Diagram</span></div>
            <div class="bg-slate-50 rounded-lg p-6 flex justify-center"><pre class="mermaid">${node.erDiagram}</pre></div>
        </div>
        <div class="detail-card">
            <div class="detail-header"><i data-lucide="table" class="w-5 h-5 text-slate-400"></i><span class="detail-title">Schema Definitions</span></div>
            <div class="grid grid-cols-1 gap-4">
                ${node.tables.map(t => `
                    <div class="border border-slate-200 rounded-lg overflow-hidden">
                        <div class="bg-slate-50 px-4 py-2 border-b border-slate-200 font-bold text-slate-700 text-sm font-mono flex justify-between">
                            ${t.name} <span class="font-normal text-slate-400 text-xs">${t.desc}</span>
                        </div>
                        <div class="p-3 grid gap-1">
                            ${t.columns.map(c => `
                                <div class="grid grid-cols-12 text-xs py-1 px-2 rounded hover:bg-slate-50">
                                    <div class="col-span-4 font-medium text-slate-700 flex items-center gap-1">
                                        ${c.flags.includes('PK') ? '<i data-lucide="key" class="w-3 h-3 text-amber-500"></i>' : ''} ${c.name}
                                    </div>
                                    <div class="col-span-4 text-slate-400 font-mono">${c.type}</div>
                                    <div class="col-span-4 flex justify-end gap-1">
                                        ${c.flags.map(f => `<span class="bg-slate-100 border border-slate-200 text-slate-500 px-1.5 rounded text-[10px]">${f}</span>`).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
        }

        function renderScriptContent(node) {
            if (!node.functions) return '';
            return `
        <div class="detail-card">
            <div class="detail-header"><i data-lucide="cpu" class="w-5 h-5 text-slate-400"></i><span class="detail-title">Business Logic</span></div>
            <div class="space-y-4">
                ${node.functions.map(fn => `
                    <div class="p-4 border border-slate-200 rounded-xl hover:border-blue-300 hover:shadow-md transition-all bg-white group">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-bold text-slate-800 font-mono text-base group-hover:text-blue-600 transition-colors">${fn.name}</h4>
                            ${fn.tag ? `<span class="px-2 py-0.5 rounded text-xs font-bold ${fn.tag === 'P0' ? 'bg-rose-50 text-rose-600 border border-rose-100' : 'bg-slate-100 text-slate-500'}">${fn.tag}</span>` : ''}
                        </div>
                        <p class="text-sm text-slate-500 mb-4 border-l-2 border-slate-200 pl-3">${fn.desc}</p>
                        ${fn.flow ? `
                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                                <div class="text-[10px] text-slate-400 uppercase font-bold mb-2 tracking-wider">Execution Flow</div>
                                <div class="flex flex-wrap items-center">
                                    ${fn.flow.map((step, i) => `
                                        <span class="flow-pill shadow-sm group-hover:border-blue-200 group-hover:bg-white">${step}</span>
                                        ${i < fn.flow.length - 1 ? '<i data-lucide="arrow-right" class="w-4 h-4 text-slate-300 mr-2 mb-2"></i>' : ''}
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `).join('')}
            </div>
        </div>
    `;
        }

        // Init
        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            renderTree(SYSTEM_DATA, 0, document.getElementById('tree-root'));
            renderDetail(SYSTEM_DATA);
        });
    </script>
</body>

</html>