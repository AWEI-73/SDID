<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“ Blueprint Studio - SDID è—åœ–å·¥ä½œå®¤</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',system-ui,sans-serif;background:#0f172a;color:#e2e8f0;min-height:100vh}
.app{display:grid;grid-template-columns:420px 1fr;height:100vh}
@media(max-width:900px){.app{grid-template-columns:1fr;grid-template-rows:50vh 50vh}}

/* Left Panel */
.left{background:#1e293b;border-right:1px solid #334155;display:flex;flex-direction:column;overflow:hidden}
.hdr{padding:12px 16px;border-bottom:1px solid #334155;background:#0f172a}
.hdr h1{font-size:1.1rem;margin-bottom:8px}
.cfg{display:flex;gap:6px;margin-bottom:6px}
.cfg input,.cfg select{flex:1;background:#1e293b;border:1px solid #475569;color:#e2e8f0;padding:5px 8px;border-radius:5px;font-size:.82rem}
.cfg select{flex:0 0 130px}
#endpointRow{display:none}

/* Steps */
.steps{display:flex;padding:6px 10px;gap:3px;border-bottom:1px solid #334155;background:#0f172a}
.stp{flex:1;text-align:center;padding:5px 2px;border-radius:5px;font-size:.68rem;font-weight:600;background:#1e293b;color:#64748b;transition:.2s}
.stp.done{background:#166534;color:#86efac}
.stp.cur{background:#1e3a5f;color:#38bdf8;box-shadow:0 0 8px rgba(56,189,248,.3)}
</style>
</head>
<body>
<div class="app">
<div class="left">
<div class="hdr">
<h1>ğŸ“ Blueprint Studio</h1>
<div class="cfg">
<select id="prov" onchange="onProvChange()">
<option value="openai">OpenAI</option>
<option value="anthropic">Anthropic</option>
<option value="custom">Custom</option>
</select>
<input type="password" id="apiKey" placeholder="API Key..." />
</div>
<div class="cfg">
<input id="model" placeholder="Model" value="gpt-4o" />
</div>
<div class="cfg" id="endpointRow">
<input id="endpoint" placeholder="https://your-api/v1/chat/completions" />
</div>
</div>
<div class="steps" id="stepBar">
<div class="stp cur" data-r="1">ğŸ¯ R1 ç›®æ¨™</div>
<div class="stp" data-r="2">ğŸ“¦ R2 å¯¦é«”</div>
<div class="stp" data-r="3">ğŸ§© R3 æ¨¡çµ„</div>
<div class="stp" data-r="4">ğŸ“… R4 è¿­ä»£</div>
<div class="stp" data-r="5">ğŸ“‹ R5 å‹•ä½œ</div>
<div class="stp" data-r="6">âœ… å®Œæˆ</div>
</div>
<div class="chat" id="chat"></div>
<div class="ipt">
<textarea id="inp" placeholder="æè¿°ä½ çš„å°ˆæ¡ˆéœ€æ±‚..." rows="3"></textarea>
<div class="btns">
<button id="sendBtn" onclick="send()">ç™¼é€</button>
<button onclick="resetAll()" class="btn2">é‡ç½®</button>
</div>
</div>
</div>

<!-- Right Panel -->
<div class="right">
<div class="tabs-bar">
<div class="tabs">
<button class="tb active" onclick="switchTab(this,'prev')">ğŸ“Š é è¦½</button>
<button class="tb" onclick="switchTab(this,'md')">ğŸ“ Markdown</button>
<button class="tb" onclick="switchTab(this,'val')">âœ… é©—è­‰</button>
</div>
<div class="acts">
<button onclick="exportMD()" class="btn-ex">ğŸ’¾ åŒ¯å‡º MD</button>
<button onclick="exportHTML()" class="btn-ex">ğŸŒ åŒ¯å‡º HTML</button>
</div>
</div>
<div class="pane" id="prevPane">
<div class="empty" id="emptyState">
<div style="font-size:3.5rem;margin-bottom:12px">ğŸ“</div>
<h2>SDID è—åœ–å·¥ä½œå®¤</h2>
<p>åœ¨å·¦å´è¼¸å…¥å°ˆæ¡ˆéœ€æ±‚ï¼ŒAI å¼•å° 5 è¼ªå°è©±ç”¢å‡º Enhanced Draft</p>
<div class="rg">
<div>ğŸ¯ Round 1: ç›®æ¨™é‡æ¸…</div>
<div>ğŸ“¦ Round 2: å¯¦é«”è­˜åˆ¥</div>
<div>ğŸ§© Round 3: æ¨¡çµ„æ‹†åˆ†</div>
<div>ğŸ“… Round 4: è¿­ä»£è¦åŠƒ</div>
<div>ğŸ“‹ Round 5: å‹•ä½œç´°åŒ–</div>
</div>
</div>
<div id="vizContent" style="display:none"></div>
</div>
<div class="pane" id="mdPane" style="display:none">
<pre id="mdOutput" style="white-space:pre-wrap;font-size:.85rem;line-height:1.5;color:#cbd5e1;padding:16px"></pre>
</div>
<div class="pane" id="valPane" style="display:none">
<div id="valOutput" style="padding:16px"></div>
</div>
</div>
</div>
<style>
/* Chat */
.chat{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:6px}
.msg{padding:9px 12px;border-radius:9px;max-width:95%;font-size:.87rem;line-height:1.5;word-wrap:break-word}
.mu{background:#1e3a5f;align-self:flex-end;border-bottom-right-radius:2px}
.ma{background:#334155;align-self:flex-start;border-bottom-left-radius:2px}
.ms{background:#0f172a;border:1px solid #475569;align-self:center;text-align:center;font-size:.78rem;color:#94a3b8;padding:6px 14px}
.ma table{width:100%;border-collapse:collapse;margin:6px 0;font-size:.78rem}
.ma th{background:#1e293b;padding:3px 6px;text-align:left;border:1px solid #475569}
.ma td{padding:3px 6px;border:1px solid #475569}
.ma code{background:#0f172a;padding:1px 3px;border-radius:3px;font-size:.78rem}
.ma h3,.ma h4{margin:6px 0 3px;color:#38bdf8;font-size:.95rem}
.ma ul,.ma ol{margin:3px 0;padding-left:18px}
.ma strong{color:#f1f5f9}
.ma blockquote{border-left:3px solid #38bdf8;padding-left:8px;margin:4px 0;color:#94a3b8}
.ma pre{background:#0f172a;padding:8px;border-radius:4px;overflow-x:auto;font-size:.78rem;margin:6px 0}
.loading::after{content:'';animation:dots 1.5s infinite}
@keyframes dots{0%{content:''}33%{content:'.'}66%{content:'..'}100%{content:'...'}}

/* Input */
.ipt{padding:10px;border-top:1px solid #334155}
.ipt textarea{width:100%;background:#0f172a;border:1px solid #475569;color:#e2e8f0;padding:8px;border-radius:7px;resize:vertical;font-family:inherit;font-size:.87rem}
.ipt textarea:focus{outline:none;border-color:#38bdf8}
.btns{display:flex;gap:6px;margin-top:6px}
.btns button{padding:7px 18px;border:none;border-radius:5px;font-weight:600;cursor:pointer;font-size:.83rem}
#sendBtn{background:#38bdf8;color:#0f172a;flex:1}
#sendBtn:hover{background:#7dd3fc}
#sendBtn:disabled{background:#475569;color:#94a3b8;cursor:not-allowed}
.btn2{background:#334155;color:#94a3b8}
.btn2:hover{background:#475569}

/* Right */
.right{display:flex;flex-direction:column;overflow:hidden}
.tabs-bar{display:flex;justify-content:space-between;align-items:center;padding:6px 14px;border-bottom:1px solid #334155;background:#1e293b}
.tabs{display:flex;gap:3px}
.tb{background:transparent;border:1px solid transparent;color:#94a3b8;padding:5px 12px;border-radius:5px;cursor:pointer;font-size:.82rem}
.tb.active{background:#0f172a;color:#38bdf8;border-color:#334155}
.acts{display:flex;gap:4px}
.btn-ex{background:#334155;border:1px solid #475569;color:#94a3b8;padding:3px 10px;border-radius:5px;cursor:pointer;font-size:.78rem}
.btn-ex:hover{background:#475569;color:#e2e8f0}
.pane{flex:1;overflow-y:auto;padding:16px}
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;text-align:center;color:#64748b}
.empty h2{color:#94a3b8;margin-bottom:6px}
.empty p{max-width:380px;margin-bottom:18px;font-size:.9rem}
.rg{display:flex;flex-direction:column;gap:4px}
.rg div{background:#1e293b;padding:6px 14px;border-radius:5px;font-size:.85rem;color:#94a3b8}
</style>
<style>
/* Viz styles */
.viz-header{background:linear-gradient(135deg,#1e293b,#0f172a);border:1px solid #334155;border-radius:10px;padding:18px;margin-bottom:18px}
.viz-header h2{font-size:1.3rem;margin-bottom:6px}
.viz-meta{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.vm{background:#1e293b;border:1px solid #475569;border-radius:5px;padding:3px 10px;font-size:.8rem}
.vm.enh{border-color:#22c55e;color:#22c55e}
.goal-box{background:#1e3a5f;border-left:4px solid #38bdf8;padding:12px;border-radius:0 7px 7px 0;margin:12px 0;font-size:1rem}
.sg{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;margin:12px 0}
.sc{background:#1e293b;border:1px solid #334155;border-radius:7px;padding:12px;text-align:center}
.sv{font-size:1.6rem;font-weight:700;color:#38bdf8}
.sl{font-size:.75rem;color:#94a3b8;margin-top:2px}
.card{background:#1e293b;border:1px solid #334155;border-radius:7px;padding:14px;margin-bottom:12px}
.card h3{font-size:1rem;margin-bottom:8px;color:#f1f5f9}
.card table{width:100%;border-collapse:collapse;font-size:.82rem}
.card th{background:#334155;padding:5px 8px;text-align:left;font-weight:600;color:#cbd5e1}
.card td{padding:5px 8px;border-bottom:1px solid #1e293b}
.card tr:hover td{background:#334155}
.card code{background:#0f172a;padding:1px 4px;border-radius:3px;font-size:.8rem;color:#a78bfa}
.ecard{border-left:3px solid #a78bfa}
.mcard{border-left:3px solid #38bdf8}
.badge{display:inline-block;padding:1px 6px;border-radius:3px;font-size:.7rem;font-weight:600}
.b-full{background:#166534;color:#86efac}
.b-part{background:#854d0e;color:#fde047}
.b-stub{background:#374151;color:#9ca3af}
.b-par{background:#1e3a5f;color:#38bdf8}
.pb{display:inline-block;padding:1px 6px;border-radius:3px;font-size:.7rem;font-weight:700;color:#fff}
.fc{font-family:'Fira Code',monospace;font-size:.8rem;color:#94a3b8}
.fa{color:#38bdf8;font-weight:700;margin:0 2px}
.tl-item{display:flex;gap:12px;margin-bottom:14px}
.tl-mark{min-width:60px;background:#38bdf8;color:#0f172a;font-weight:700;text-align:center;padding:6px;border-radius:7px;font-size:.85rem;height:fit-content}
.tl-body{flex:1;background:#1e293b;border:1px solid #334155;border-radius:7px;padding:12px}
.tl-hdr{font-weight:600;margin-bottom:8px}
.mg{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:6px}
.mc{background:#0f172a;border:1px solid #475569;border-radius:5px;padding:10px}
.dep{background:#1e3a5f;color:#7dd3fc;padding:1px 5px;border-radius:3px;font-size:.7rem;margin-right:3px}
.fi{padding:3px 0;font-size:.85rem}
.fi.ck{color:#86efac}
.pbar-c{display:flex;height:24px;border-radius:5px;overflow:hidden;background:#0f172a;margin:6px 0}
.pbar{display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:700;color:#fff;transition:width .3s}
.arch-l{display:flex;flex-direction:column;gap:3px;margin:10px 0}
.al{display:flex;align-items:center;gap:6px;padding:5px 10px;border-radius:3px;font-size:.82rem;background:#0f172a;border:1px solid #334155}
.al .ln{min-width:20px;height:20px;background:#38bdf8;color:#0f172a;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.7rem}
.al .lname{font-weight:600;min-width:70px}
.al .ldesc{color:#94a3b8}
.sec-h{font-size:1.1rem;margin:24px 0 12px;padding-bottom:6px;border-bottom:2px solid #334155;color:#38bdf8}
.sec-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
/* Validation */
.vr{padding:6px 0;font-size:.9rem}
.vr.pass{color:#86efac}
.vr.warn{color:#fde047}
.vr.fail{color:#f87171}
</style>
<script>
// ============================================
// STATE
// ============================================
let messages = []; // {role, content}
let currentRound = 1;
let draftMarkdown = '';
let sending = false;

const ROUNDS = [
  {r:1, label:'ç›®æ¨™é‡æ¸…', icon:'ğŸ¯', hint:'è«‹æè¿°ä½ çš„å°ˆæ¡ˆéœ€æ±‚ï¼šè¦è§£æ±ºä»€éº¼å•é¡Œï¼Ÿèª°æœƒç”¨ï¼Ÿ'},
  {r:2, label:'å¯¦é«”è­˜åˆ¥', icon:'ğŸ“¦', hint:'ç³»çµ±éœ€è¦ç®¡ç†å“ªäº›è³‡æ–™ï¼Ÿ'},
  {r:3, label:'æ¨¡çµ„æ‹†åˆ†', icon:'ğŸ§©', hint:'å“ªäº›åŠŸèƒ½æ˜¯å…±ç”¨çš„ï¼Ÿå“ªäº›æ˜¯ç‰¹å®šè§’è‰²å°ˆå±¬çš„ï¼Ÿ'},
  {r:4, label:'è¿­ä»£è¦åŠƒ', icon:'ğŸ“…', hint:'MVP è¦åšåˆ°ä»€éº¼ç¨‹åº¦ï¼Ÿå“ªäº›å¾Œé¢å†åšï¼Ÿ'},
  {r:5, label:'å‹•ä½œç´°åŒ–', icon:'ğŸ“‹', hint:'æ¯å€‹æ¨¡çµ„å…·é«”è¦åšå“ªäº›æ“ä½œï¼Ÿ'},
  {r:6, label:'å®Œæˆ', icon:'âœ…', hint:'Enhanced Draft å·²ç”¢å‡º'}
];

// ============================================
// SYSTEM PROMPT (from blueprint-architect.cjs)
// ============================================
const SYSTEM_PROMPT = `ä½ æ˜¯ SDID è—åœ–æ¶æ§‹å¸« (Blueprint Architect)ã€‚
ä½ çš„ä»»å‹™æ˜¯é€é 5 è¼ªçµæ§‹åŒ–å°è©±ï¼Œå°‡ä½¿ç”¨è€…çš„éœ€æ±‚è½‰åŒ–ç‚ºä¸€ä»½ Enhanced Draft (Markdown æ ¼å¼)ã€‚

## ç”¢å‡ºè·¯å¾‘
å®Œæˆçš„ Enhanced Draft æ”¾åœ¨ï¼š\`{å°ˆæ¡ˆ}/.gems/iterations/iter-1/poc/requirement_draft_iter-1.md\`

## æ ¸å¿ƒåŸå‰‡
- æ¯è¼ªåªèšç„¦ä¸€å€‹ä¸»é¡Œï¼Œä¸è¦ä¸€æ¬¡å•å¤ªå¤š
- ä½¿ç”¨è€…å›ç­”æ¨¡ç³Šæ™‚ï¼Œçµ¦å‡º 2-3 å€‹å…·é«”é¸é …è®“ä»–é¸
- æ¯è¼ªçµæŸæ™‚ï¼Œç”¨è¡¨æ ¼æˆ–æ¸…å–®ç¸½çµè©²è¼ªæˆæœï¼Œè«‹ä½¿ç”¨è€…ç¢ºèªå¾Œå†é€²å…¥ä¸‹ä¸€è¼ª
- ä½¿ç”¨ç¹é«”ä¸­æ–‡
- ä¸è¦è…¦è£œï¼Œä¸ç¢ºå®šå°±å•

## é‡è¦ï¼šè¼ªæ¬¡è¿½è¹¤
ä½ å¿…é ˆåœ¨æ¯æ¬¡å›è¦†çš„æœ€å¾Œä¸€è¡ŒåŠ ä¸Šéš±è—æ¨™è¨˜ï¼š<!-- ROUND:N --> (N=ç•¶å‰è¼ªæ¬¡ 1-5)
ç•¶ä½ èªç‚ºè©²è¼ªå·²å®Œæˆï¼ˆä½¿ç”¨è€…ç¢ºèªäº†ï¼‰ï¼Œä¸‹ä¸€æ¬¡å›è¦†æ”¹ç‚º <!-- ROUND:N+1 -->
ç¬¬ 5 è¼ªçµæŸå¾Œï¼Œè¼¸å‡ºå®Œæ•´çš„ Enhanced Draft Markdownï¼Œä¸¦æ¨™è¨˜ <!-- ROUND:DONE -->

## æ¨¡çµ„åŒ–æ¶æ§‹æ¦‚å¿µ
### æ©«å‘åˆ†å±¤ (6 å±¤)
| å±¤ç´š | ç›®éŒ„ | è·è²¬ | ä¾è³´é™åˆ¶ |
|------|------|------|---------|
| 1. Config | src/config/ | å…¨åŸŸé…ç½® | ä¸å¯ä¾è³´å…¶ä»–å±¤ |
| 2. Assets | src/assets/ | éœæ…‹è³‡æº | ä¸å¯ä¾è³´å…¶ä»–å±¤ |
| 3. Lib | src/lib/ | ç¬¬ä¸‰æ–¹åº«å°è£ | åƒ…ä¾è³´ Config |
| 4. Shared | src/shared/ | è·¨æ¨¡çµ„å…±ç”¨ | ä¾è³´ Config, Lib, Assets |
| 5. Modules | src/modules/ | æ ¸å¿ƒæ¥­å‹™ (å‚ç›´åˆ†ç‰‡) | ä¾è³´ Shared, Config, Lib |
| 6. Routes | src/routes/ | è·¯ç”±å®šç¾© | ä¾è³´ Modules, Shared |

### æ¨™æº–æ¨¡çµ„å…§éƒ¨çµæ§‹
index.ts (Facade) / constants.ts / types/ / api/ / services/ / hooks/ / components/ / pages/

### é—œéµè¦å‰‡
- API/Service åˆ†é›¢: API åªç®¡ HTTPï¼ŒService ç®¡è³‡æ–™è½‰æ›
- DTO vs Domain Model: åœ¨ Service å±¤è½‰æ›
- Hooks å„ªå…ˆ: é‚è¼¯å¾ UI æŠ½é›¢è‡³ hooks/

## å°è©±æµç¨‹
### Round 1: ç›®æ¨™é‡æ¸… â†’ ä¸€å¥è©±ç›®æ¨™ + æ—ç¾¤è­˜åˆ¥è¡¨
### Round 2: å¯¦é«”è­˜åˆ¥ â†’ å¯¦é«”å®šç¾©è¡¨æ ¼
### Round 3: æ¨¡çµ„æ‹†åˆ† â†’ å…±ç”¨æ¨¡çµ„ + ç¨ç«‹æ¨¡çµ„ + è·¯ç”±çµæ§‹
### Round 4: è¿­ä»£è¦åŠƒ â†’ è¿­ä»£è¦åŠƒè¡¨ + ä¸åšä»€éº¼
### Round 5: å‹•ä½œç´°åŒ– â†’ æ¨¡çµ„å‹•ä½œæ¸…å–®

## å‹•ä½œé¡å‹ â†’ æ¨¡çµ„ç›®éŒ„æ˜ å°„
| é¡å‹ | å°æ‡‰ç›®éŒ„ | èªªæ˜ |
|------|---------|------|
| CONST | constants.ts | å¸¸æ•¸/é…ç½® |
| LIB | lib/ | ç¬¬ä¸‰æ–¹åº«å°è£ |
| API | api/ | ç´” HTTP è«‹æ±‚ |
| SVC | services/ | æ¥­å‹™é‚è¼¯/è³‡æ–™è½‰æ› |
| HOOK | hooks/ | äº’å‹•é‚è¼¯ |
| UI | components/ | ä»‹é¢å…ƒä»¶ |
| ROUTE | pages/ | è·¯ç”±é é¢ |

## è¦æ¨¡: S(â‰¤3) / M(â‰¤6) / L(â‰¤10 Stories)
## å„ªå…ˆç´š: P0(ç«¯åˆ°ç«¯) / P1(æ•´åˆ) / P2(ç¨ç«‹) / P3(è¼”åŠ©)

## ç¬¬ 5 è¼ªçµæŸå¾Œ
çµ„è£å®Œæ•´ Enhanced Draft Markdown (åŒ…å«æ‰€æœ‰å€å¡Š)ï¼Œè¨­å®š POC Levelã€‚`;
</script>
<script>
// ============================================
// UI HELPERS
// ============================================
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}

function onProvChange(){
  const p=document.getElementById('prov').value;
  const er=document.getElementById('endpointRow');
  const m=document.getElementById('model');
  er.style.display=p==='custom'?'flex':'none';
  if(p==='openai')m.value='gpt-4o';
  else if(p==='anthropic')m.value='claude-sonnet-4-20250514';
  else m.value='';
}

function updateSteps(){
  document.querySelectorAll('.stp').forEach(el=>{
    const r=parseInt(el.dataset.r);
    el.classList.remove('done','cur');
    if(r<currentRound)el.classList.add('done');
    else if(r===currentRound)el.classList.add('cur');
  });
}

function addMsg(role, content){
  const chat=document.getElementById('chat');
  const div=document.createElement('div');
  if(role==='user'){div.className='msg mu';div.innerHTML=esc(content).replace(/\n/g,'<br>');}
  else if(role==='system'){div.className='msg ms';div.textContent=content;}
  else{div.className='msg ma';div.innerHTML=renderMd(content);}
  chat.appendChild(div);
  chat.scrollTop=chat.scrollHeight;
  return div;
}

function switchTab(btn, id){
  document.querySelectorAll('.tb').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.pane').forEach(p=>p.style.display='none');
  document.getElementById(id+'Pane').style.display='block';
}

// ============================================
// SIMPLE MARKDOWN RENDERER
// ============================================
function renderMd(text){
  // Remove hidden round markers from display
  let s=text.replace(/<!--\s*ROUND:\w+\s*-->/g,'');
  // Code blocks
  s=s.replace(/```(\w*)\n([\s\S]*?)```/g,(_,lang,code)=>`<pre><code>${esc(code)}</code></pre>`);
  // Tables
  s=s.replace(/^(\|.+\|)\n(\|[-:\s|]+\|)\n((?:\|.+\|\n?)*)/gm,(_,hdr,sep,body)=>{
    const ths=hdr.split('|').filter(c=>c.trim()).map(c=>`<th>${c.trim()}</th>`).join('');
    const rows=body.trim().split('\n').map(r=>{
      const tds=r.split('|').filter(c=>c.trim()).map(c=>`<td>${c.trim()}</td>`).join('');
      return `<tr>${tds}</tr>`;
    }).join('');
    return `<table><thead><tr>${ths}</tr></thead><tbody>${rows}</tbody></table>`;
  });
  // Headers
  s=s.replace(/^#### (.+)$/gm,'<h4>$1</h4>');
  s=s.replace(/^### (.+)$/gm,'<h3>$1</h3>');
  s=s.replace(/^## (.+)$/gm,'<h3>$1</h3>');
  // Bold
  s=s.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  // Inline code
  s=s.replace(/`([^`]+)`/g,'<code>$1</code>');
  // Blockquote
  s=s.replace(/^> (.+)$/gm,'<blockquote>$1</blockquote>');
  // Lists
  s=s.replace(/^- \[x\] (.+)$/gm,'<div class="fi ck">âœ… $1</div>');
  s=s.replace(/^- \[ \] (.+)$/gm,'<div class="fi">â¬œ $1</div>');
  s=s.replace(/^- (.+)$/gm,'<div style="padding-left:12px">â€¢ $1</div>');
  // Line breaks
  s=s.replace(/\n\n/g,'<br><br>');
  s=s.replace(/\n/g,'<br>');
  return s;
}
</script>
<script>
// ============================================
// API CALL
// ============================================
async function callAPI(msgs){
  const prov=document.getElementById('prov').value;
  const key=document.getElementById('apiKey').value.trim();
  const model=document.getElementById('model').value.trim();
  const customEp=document.getElementById('endpoint').value.trim();

  if(!key)throw new Error('è«‹è¼¸å…¥ API Key');
  if(!model)throw new Error('è«‹è¼¸å…¥ Model åç¨±');

  if(prov==='anthropic'){
    // Anthropic Messages API
    const url='https://api.anthropic.com/v1/messages';
    const sysMsg=msgs.find(m=>m.role==='system');
    const chatMsgs=msgs.filter(m=>m.role!=='system');
    const resp=await fetch(url,{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'x-api-key':key,
        'anthropic-version':'2023-06-01',
        'anthropic-dangerous-direct-browser-access':'true'
      },
      body:JSON.stringify({
        model,
        max_tokens:8192,
        system:sysMsg?sysMsg.content:'',
        messages:chatMsgs.map(m=>({role:m.role,content:m.content}))
      })
    });
    if(!resp.ok){const e=await resp.text();throw new Error(`Anthropic API éŒ¯èª¤ (${resp.status}): ${e}`);}
    const data=await resp.json();
    return data.content[0].text;
  } else {
    // OpenAI-compatible
    const url=prov==='custom'&&customEp?customEp:'https://api.openai.com/v1/chat/completions';
    const resp=await fetch(url,{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':`Bearer ${key}`},
      body:JSON.stringify({model,messages:msgs,max_tokens:8192,temperature:0.7})
    });
    if(!resp.ok){const e=await resp.text();throw new Error(`API éŒ¯èª¤ (${resp.status}): ${e}`);}
    const data=await resp.json();
    return data.choices[0].message.content;
  }
}

// ============================================
// SEND MESSAGE
// ============================================
async function send(){
  if(sending)return;
  const inp=document.getElementById('inp');
  const text=inp.value.trim();
  if(!text)return;

  sending=true;
  document.getElementById('sendBtn').disabled=true;
  inp.value='';

  // Add user message
  addMsg('user',text);
  messages.push({role:'user',content:text});

  // Show loading
  const loadDiv=addMsg('assistant','æ€è€ƒä¸­');
  loadDiv.classList.add('loading');

  try{
    const apiMsgs=[{role:'system',content:SYSTEM_PROMPT},...messages];
    const reply=await callAPI(apiMsgs);

    // Remove loading
    loadDiv.remove();

    // Detect round marker
    const roundMatch=reply.match(/<!--\s*ROUND:(\w+)\s*-->/);
    if(roundMatch){
      const val=roundMatch[1];
      if(val==='DONE'){
        currentRound=6;
        // Extract the draft markdown (everything in the reply)
        draftMarkdown=reply.replace(/<!--\s*ROUND:\w+\s*-->/g,'').trim();
        updatePreview();
      } else {
        const n=parseInt(val);
        if(!isNaN(n)&&n>=1&&n<=5){
          if(n>currentRound)currentRound=n;
        }
      }
    }

    // Check if reply contains a full Enhanced Draft (fallback detection)
    if(!draftMarkdown && reply.includes('Enhanced Blueprint Draft') && reply.includes('æ¨¡çµ„å‹•ä½œæ¸…å–®')){
      draftMarkdown=reply.replace(/<!--\s*ROUND:\w+\s*-->/g,'').trim();
      currentRound=6;
      updatePreview();
    }

    addMsg('assistant',reply);
    messages.push({role:'assistant',content:reply});
    updateSteps();

    // Update hint
    if(currentRound<=5){
      inp.placeholder=ROUNDS[currentRound-1].hint;
    } else {
      inp.placeholder='Draft å·²å®Œæˆï¼å¯ç¹¼çºŒå°è©±ä¿®æ”¹ï¼Œæˆ–åŒ¯å‡ºçµæœã€‚';
    }
  }catch(err){
    loadDiv.remove();
    addMsg('system','âŒ '+err.message);
  }

  sending=false;
  document.getElementById('sendBtn').disabled=false;
  inp.focus();
}

// Enter to send (Shift+Enter for newline)
document.getElementById('inp').addEventListener('keydown',e=>{
  if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send();}
});
</script>
<script>
// ============================================
// DRAFT PARSER (browser-side, mirrors draft-parser.cjs)
// ============================================
function parseDraft(md){
  const d={title:'',iteration:'',date:'',level:'',goal:'',requirement:'',
    groups:[],entities:{},sharedModules:[],modules:{},routes:'',
    iterationPlan:[],moduleActions:{},features:[],exclusions:[],clarifications:{}};

  // Title
  const tm=md.match(/^#\s+ğŸ“‹\s+(.+?)\s*-\s*éœ€æ±‚è‰ç¨¿/m);
  if(tm)d.title=tm[1].trim();

  // Meta
  const im=md.match(/\*\*è¿­ä»£\*\*:\s*(\S+)/);if(im)d.iteration=im[1];
  const dm=md.match(/\*\*æ—¥æœŸ\*\*:\s*(\S+)/);if(dm)d.date=dm[1];
  const lm=md.match(/\*\*è¦æ¨¡\*\*:\s*(\S+)/);if(lm)d.level=lm[1];

  // Goal
  const gm=md.match(/## ä¸€å¥è©±ç›®æ¨™\s*\n+(.+)/);if(gm)d.goal=gm[1].trim();

  // Requirement
  const rm=md.match(/## ç”¨æˆ¶åŸå§‹éœ€æ±‚\s*\n+>\s*(.+(?:\n>\s*.+)*)/);
  if(rm)d.requirement=rm[1].replace(/^>\s*/gm,'').trim();

  // Groups table
  const gsec=md.match(/### 1\. æ—ç¾¤è­˜åˆ¥[\s\S]*?\n(\|.+\|[\s\S]*?)(?=\n###|\n---|\n##|$)/);
  if(gsec){
    const rows=gsec[1].trim().split('\n').filter(r=>r.includes('|')&&!r.match(/^[\s|:-]+$/));
    rows.shift(); // header
    for(const r of rows){
      const cols=r.split('|').map(c=>c.trim()).filter(Boolean);
      if(cols.length>=3&&!cols[0].startsWith('{'))d.groups.push({name:cols[0],desc:cols[1],needs:cols[2]});
    }
  }

  // Entities
  const entRe=/####\s+(\w+)\s*\n(\|.+\|[\s\S]*?)(?=\n####|\n###|\n---|\n##|$)/g;
  let em2;
  while((em2=entRe.exec(md))!==null){
    const name=em2[1];
    if(name.match(/^(æ¨¡çµ„|Iter|Shared)/))continue;
    const rows=em2[2].trim().split('\n').filter(r=>r.includes('|')&&!r.match(/^[\s|:-]+$/));
    rows.shift();
    const fields=[];
    for(const r of rows){
      const c=r.split('|').map(x=>x.trim()).filter(Boolean);
      if(c.length>=4&&!c[0].startsWith('{'))fields.push({field:c[0],type:c[1],constraint:c[2],desc:c[3]});
    }
    if(fields.length>0)d.entities[name]=fields;
  }

  // Shared modules
  const ssec=md.match(/### 3\. å…±ç”¨æ¨¡çµ„[\s\S]*?\n((?:- \[.\].+\n?)+)/);
  if(ssec){
    for(const line of ssec[1].trim().split('\n')){
      const m2=line.match(/- \[(x| )\]\s*(.+)/);
      if(m2)d.sharedModules.push({checked:m2[1]==='x',text:m2[2].trim()});
    }
  }

  // Independent modules
  const msec=md.match(/### 4\. ç¨ç«‹æ¨¡çµ„[\s\S]*?(?=\n### 5\.|\n---|\n## ğŸ“…|$)/);
  if(msec){
    const mRe=/####\s+æ¨¡çµ„[ï¼š:]\s*(\S+)(?:\s*\(([^)]+)\))?\s*\n([\s\S]*?)(?=\n####|\n###|\n---|\n##|$)/g;
    let mm;
    while((mm=mRe.exec(msec[0]))!==null){
      const name=mm[1],label=mm[2]||'';
      const body=mm[3];
      const deps=[];
      const dm2=body.match(/ä¾è³´:\s*\[([^\]]*)\]/);
      if(dm2)deps.push(...dm2[1].split(',').map(x=>x.trim()).filter(Boolean));
      const feats=[];
      const fRe=/- \[(x| )\]\s*(.+)/g;
      let fm;
      while((fm=fRe.exec(body))!==null)feats.push({checked:fm[1]==='x',text:fm[2].trim()});
      d.modules[name]={label,deps,features:feats};
    }
  }

  // Routes
  const rsec=md.match(/### 5\. è·¯ç”±çµæ§‹[\s\S]*?```\s*\n?([\s\S]*?)```/);
  if(rsec)d.routes=rsec[1].trim();

  // Iteration plan table
  const ipsec=md.match(/## ğŸ“… è¿­ä»£è¦åŠƒè¡¨[\s\S]*?\n(\|.+\|[\s\S]*?)(?=\n>|\n---|\n##|$)/);
  if(ipsec){
    const rows=ipsec[1].trim().split('\n').filter(r=>r.includes('|')&&!r.match(/^[\s|:-]+$/));
    rows.shift();
    for(const r of rows){
      const c=r.split('|').map(x=>x.trim()).filter(Boolean);
      if(c.length>=5)d.iterationPlan.push({iter:parseInt(c[0])||c[0],scope:c[1],goal:c[2],module:c[3],deps:c[4]});
    }
  }

  // Module actions
  const masec=md.match(/## ğŸ“‹ æ¨¡çµ„å‹•ä½œæ¸…å–®[\s\S]*?(?=\n## åŠŸèƒ½|\n---\s*\n## åŠŸèƒ½|$)/);
  if(masec){
    const maRe=/### Iter (\d+):\s*(\S+)(?:\s*\((\w+)\))?\s*\n([\s\S]*?)(?=\n### Iter|\n---|\n## |$)/g;
    let mam;
    while((mam=maRe.exec(masec[0]))!==null){
      const iter=parseInt(mam[1]),name=mam[2],fillHint=mam[3]||'';
      const body=mam[4].trim();
      if(body.startsWith('>')){
        d.moduleActions[name]={iter,fillLevel:'stub',stubDescription:body.replace(/^>\s*/,''),items:[]};
      } else {
        const rows=body.split('\n').filter(r=>r.includes('|')&&!r.match(/^[\s|:-]+$/)&&!r.match(/æ¥­å‹™èªæ„/));
        const items=[];
        for(const r of rows){
          const c=r.split('|').map(x=>x.trim()).filter(Boolean);
          if(c.length>=5)items.push({semantic:c[0],type:c[1],techName:c[2],priority:c[3],flow:c[4]});
        }
        const fl=fillHint.toLowerCase()==='stub'?'stub':fillHint.toLowerCase()==='partial'?'partial':items.length>0?'full':'stub';
        d.moduleActions[name]={iter,fillLevel:fl,items};
      }
    }
  }

  // Features
  const fsec=md.match(/## åŠŸèƒ½æ¨¡çµ„æ¸…å–®\s*\n([\s\S]*?)(?=\n### ä¸åš|\n---|\n## é‡æ¸…|$)/);
  if(fsec){
    const fRe=/- \[(x| )\]\s*(.+)/g;
    let fm;
    while((fm=fRe.exec(fsec[1]))!==null)d.features.push({checked:fm[1]==='x',text:fm[2].trim()});
  }

  // Exclusions
  const esec=md.match(/### ä¸åšä»€éº¼\s*\n([\s\S]*?)(?=\n---|\n##|$)/);
  if(esec){
    for(const line of esec[1].trim().split('\n')){
      const m2=line.match(/^-\s+(.+)/);
      if(m2&&!m2[1].startsWith('{'))d.exclusions.push(m2[1].trim());
    }
  }

  return d;
}

function calcStats(d){
  const totalModules=Object.keys(d.modules).length;
  const totalEntities=Object.keys(d.entities).length;
  let totalActions=0;
  const priorities={P0:0,P1:0,P2:0,P3:0};
  for(const[,a]of Object.entries(d.moduleActions)){
    for(const item of(a.items||[])){
      totalActions++;
      if(priorities[item.priority]!==undefined)priorities[item.priority]++;
    }
  }
  const totalIterations=d.iterationPlan.length||new Set(Object.values(d.moduleActions).map(a=>a.iter)).size;
  return{totalModules,totalEntities,totalActions,totalIterations,priorities};
}
</script>
<script>
// ============================================
// VISUALIZATION RENDERER
// ============================================
function renderViz(d){
  const s=calcStats(d);
  const pC={P0:'#ef4444',P1:'#f59e0b',P2:'#3b82f6',P3:'#6b7280'};
  const tot=s.totalActions||1;

  // Priority bars
  const pBars=['P0','P1','P2','P3'].map(p=>{
    const n=s.priorities[p]||0;const pct=Math.round(n/tot*100);
    return `<div class="pbar" style="width:${Math.max(pct,2)}%;background:${pC[p]}" title="${p}:${n}">${n>0?`${p}(${n})`:''}</div>`;
  }).join('');

  // Entities
  let entHTML='';
  for(const[name,fields]of Object.entries(d.entities)){
    const rows=fields.map(f=>`<tr><td>${esc(f.field)}</td><td><code>${esc(f.type)}</code></td><td>${esc(f.constraint)}</td><td>${esc(f.desc)}</td></tr>`).join('');
    entHTML+=`<div class="card ecard"><h3>ğŸ“¦ ${esc(name)}</h3><table><thead><tr><th>æ¬„ä½</th><th>å‹åˆ¥</th><th>ç´„æŸ</th><th>èªªæ˜</th></tr></thead><tbody>${rows}</tbody></table></div>`;
  }

  // Groups
  let grpHTML='';
  if(d.groups.length>0){
    const rows=d.groups.map(g=>`<tr><td><strong>${esc(g.name)}</strong></td><td>${esc(g.desc)}</td><td>${esc(g.needs)}</td></tr>`).join('');
    grpHTML=`<div class="card"><table><thead><tr><th>æ—ç¾¤</th><th>æè¿°</th><th>ç‰¹æ®Šéœ€æ±‚</th></tr></thead><tbody>${rows}</tbody></table></div>`;
  }

  // Modules
  let modHTML='';
  for(const[name,mod]of Object.entries(d.modules)){
    const deps=(mod.deps||[]).map(x=>`<span class="dep">${esc(x)}</span>`).join(' ')||'<span style="color:#64748b;font-size:.75rem">ç„¡</span>';
    const feats=(mod.features||[]).map(f=>`<div class="fi ${f.checked?'ck':''}">${f.checked?'âœ…':'â¬œ'} ${esc(f.text)}</div>`).join('');
    modHTML+=`<div class="card mcard"><h3>ğŸ§© ${esc(name)}${mod.label?' ('+esc(mod.label)+')':''}</h3><div style="font-size:.8rem;color:#94a3b8;margin:4px 0">ä¾è³´: ${deps}</div>${feats}</div>`;
  }

  // Timeline
  let tlHTML='';
  for(const ip of d.iterationPlan){
    const canPar=ip.deps==='ç„¡'||ip.deps==='-';
    const parBadge=canPar?'<span class="badge b-par">âš¡ å¯ä¸¦è¡Œ</span>':'';
    // Find module actions for this iter
    const mods=Object.entries(d.moduleActions).filter(([,a])=>a.iter===ip.iter||String(a.iter)===String(ip.iter));
    let modCards='';
    for(const[mn,ma]of mods){
      const fb=ma.fillLevel==='full'?'<span class="badge b-full">Full</span>':ma.fillLevel==='partial'?'<span class="badge b-part">Partial</span>':'<span class="badge b-stub">Stub</span>';
      modCards+=`<div class="mc"><strong>${esc(mn)}</strong> ${fb}<div style="font-size:.78rem;color:#64748b">${ma.items.length} å€‹å‹•ä½œ</div></div>`;
    }
    tlHTML+=`<div class="tl-item"><div class="tl-mark">Iter ${ip.iter}</div><div class="tl-body"><div class="tl-hdr">${esc(ip.goal||ip.scope||'')} ${parBadge}</div><div class="mg">${modCards}</div></div></div>`;
  }

  // Actions
  let actHTML='';
  for(const[name,act]of Object.entries(d.moduleActions)){
    if(act.fillLevel==='stub'){
      actHTML+=`<div class="card"><h3>ğŸ“‹ Iter ${act.iter}: ${esc(name)} <span class="badge b-stub">Stub</span></h3><p style="color:#94a3b8;font-style:italic">${esc(act.stubDescription||'å¾…ç´°åŒ–')}</p></div>`;
      continue;
    }
    const rows=(act.items||[]).map(i=>{
      const pc=pC[i.priority]||'#6b7280';
      return `<tr><td>${esc(i.semantic)}</td><td><code>${esc(i.type)}</code></td><td><strong>${esc(i.techName)}</strong></td><td><span class="pb" style="background:${pc}">${esc(i.priority)}</span></td><td class="fc">${esc(i.flow).replace(/â†’/g,'<span class="fa">â†’</span>')}</td></tr>`;
    }).join('');
    const sfx=act.fillLevel==='partial'?' <span class="badge b-part">Partial</span>':'';
    actHTML+=`<div class="card"><h3>ğŸ“‹ Iter ${act.iter}: ${esc(name)}${sfx}</h3><table><thead><tr><th>æ¥­å‹™èªæ„</th><th>é¡å‹</th><th>æŠ€è¡“åç¨±</th><th>å„ªå…ˆç´š</th><th>æµå‘</th></tr></thead><tbody>${rows}</tbody></table></div>`;
  }

  // Features
  let featHTML=(d.features||[]).map(f=>`<div class="fi ${f.checked?'ck':''}">${f.checked?'âœ…':'â¬œ'} ${esc(f.text)}</div>`).join('');

  // Exclusions
  let exclHTML=(d.exclusions||[]).map(e=>`<li>${esc(e)}</li>`).join('');

  const isEnh=Object.keys(d.entities).length>0||d.iterationPlan.length>0||Object.keys(d.moduleActions).length>0;

  return `
<div class="viz-header">
  <h2>ğŸ“ ${esc(d.title||'Blueprint')}</h2>
  <div class="viz-meta">
    <span class="vm">${esc(d.iteration||'iter-1')}</span>
    <span class="vm">${esc(d.date||'')}</span>
    <span class="vm">Level ${esc(d.level||'?')}</span>
    <span class="vm ${isEnh?'enh':''}">${isEnh?'âœ… Enhanced':'ğŸ“„ Standard'}</span>
    <span class="vm">SDID v1.0</span>
  </div>
</div>
<div class="goal-box">ğŸ¯ ${esc(d.goal||'(æœªè¨­å®š)')}</div>
<div class="sg">
  <div class="sc"><div class="sv">${s.totalModules}</div><div class="sl">æ¨¡çµ„</div></div>
  <div class="sc"><div class="sv">${s.totalEntities}</div><div class="sl">å¯¦é«”</div></div>
  <div class="sc"><div class="sv">${s.totalActions}</div><div class="sl">å‹•ä½œ</div></div>
  <div class="sc"><div class="sv">${s.totalIterations}</div><div class="sl">è¿­ä»£</div></div>
  <div class="sc"><div class="sv">${d.level||'?'}</div><div class="sl">è¦æ¨¡</div></div>
  <div class="sc"><div class="sv">${d.groups.length}</div><div class="sl">æ—ç¾¤</div></div>
</div>
<div class="sec-h">ğŸ“Š å„ªå…ˆç´šåˆ†ä½ˆ</div>
<div class="pbar-c">${pBars}</div>
<div class="sec-h">ğŸ—ï¸ æ¶æ§‹åˆ†å±¤</div>
<div class="arch-l">
  <div class="al"><span class="ln">1</span><span class="lname">Config</span><span class="ldesc">å…¨åŸŸé…ç½®</span></div>
  <div class="al"><span class="ln">2</span><span class="lname">Assets</span><span class="ldesc">éœæ…‹è³‡æº</span></div>
  <div class="al"><span class="ln">3</span><span class="lname">Lib</span><span class="ldesc">ç¬¬ä¸‰æ–¹åº«å°è£</span></div>
  <div class="al"><span class="ln">4</span><span class="lname">Shared</span><span class="ldesc">è·¨æ¨¡çµ„å…±ç”¨</span></div>
  <div class="al"><span class="ln">5</span><span class="lname">Modules</span><span class="ldesc">æ ¸å¿ƒæ¥­å‹™ (å‚ç›´åˆ†ç‰‡)</span></div>
  <div class="al"><span class="ln">6</span><span class="lname">Routes</span><span class="ldesc">è·¯ç”±å®šç¾©</span></div>
</div>
${grpHTML?`<div class="sec-h">ğŸ‘¥ æ—ç¾¤è­˜åˆ¥</div>${grpHTML}`:''}
${entHTML?`<div class="sec-h">ğŸ“¦ å¯¦é«”å®šç¾©</div>${entHTML}`:''}
${modHTML?`<div class="sec-h">ğŸ§© ç¨ç«‹æ¨¡çµ„</div><div class="sec-grid">${modHTML}</div>`:''}
${tlHTML?`<div class="sec-h">ğŸ—“ï¸ è¿­ä»£è¦åŠƒ</div>${tlHTML}`:''}
${actHTML?`<div class="sec-h">ğŸ“‹ æ¨¡çµ„å‹•ä½œæ¸…å–®</div>${actHTML}`:''}
${featHTML?`<div class="sec-h">âœ… åŠŸèƒ½æ¨¡çµ„</div><div class="card">${featHTML}</div>`:''}
${exclHTML?`<div class="sec-h">ğŸš« ä¸åšä»€éº¼</div><div class="card"><ul>${exclHTML}</ul></div>`:''}
`;
}
</script>
<script>
// ============================================
// VALIDATION
// ============================================
function validateDraft(d){
  const checks=[];
  const pass=m=>checks.push({level:'pass',msg:m});
  const warn=m=>checks.push({level:'warn',msg:m});
  const fail=m=>checks.push({level:'fail',msg:m});

  if(d.goal&&d.goal.length>=10&&!d.goal.includes('{'))pass('ä¸€å¥è©±ç›®æ¨™');else fail('ä¸€å¥è©±ç›®æ¨™æœªå¡«å¯«æˆ–éçŸ­ (â‰¥10 å­—)');
  if(d.level&&/^[SML]$/.test(d.level))pass('POC Level: '+d.level);else fail('POC Level æœªè¨­å®š (S/M/L)');
  if(d.requirement&&d.requirement.length>=20)pass('ç”¨æˆ¶åŸå§‹éœ€æ±‚');else fail('ç”¨æˆ¶åŸå§‹éœ€æ±‚éçŸ­ (â‰¥20 å­—)');
  if(d.groups.length>=1)pass('æ—ç¾¤è­˜åˆ¥: '+d.groups.length+' å€‹');else fail('æ—ç¾¤è­˜åˆ¥æœªå¡«å¯«');
  const mc=Object.keys(d.modules).length;
  if(mc>=1)pass('ç¨ç«‹æ¨¡çµ„: '+mc+' å€‹');else fail('ç¨ç«‹æ¨¡çµ„æœªå®šç¾©');
  if(d.sharedModules.some(s=>s.checked))pass('å…±ç”¨æ¨¡çµ„å·²å‹¾é¸');else fail('å…±ç”¨æ¨¡çµ„è‡³å°‘éœ€å‹¾é¸ 1 å€‹');
  if(d.routes)pass('è·¯ç”±çµæ§‹');else warn('è·¯ç”±çµæ§‹æœªå®šç¾©');
  const ec=Object.keys(d.entities).length;
  if(ec>0)pass('å¯¦é«”å®šç¾©: '+ec+' å€‹');else warn('å¯¦é«”å®šç¾©æœªå¡«å¯« (å»ºè­°)');
  if(d.iterationPlan.length>0)pass('è¿­ä»£è¦åŠƒè¡¨: '+d.iterationPlan.length+' å€‹è¿­ä»£');else warn('è¿­ä»£è¦åŠƒè¡¨æœªå¡«å¯« (å»ºè­°)');
  const ac=Object.values(d.moduleActions).reduce((n,a)=>n+(a.items||[]).length,0);
  if(ac>0)pass('æ¨¡çµ„å‹•ä½œæ¸…å–®: '+ac+' å€‹å‹•ä½œ');else warn('æ¨¡çµ„å‹•ä½œæ¸…å–®æœªå¡«å¯« (å»ºè­°)');
  const cf=d.features.filter(f=>f.checked).length;
  if(cf>=2)pass('åŠŸèƒ½æ¨¡çµ„: '+cf+' å€‹å·²å‹¾é¸');else fail('åŠŸèƒ½æ¨¡çµ„è‡³å°‘éœ€å‹¾é¸ 2 å€‹');

  const placeholders=['{å°ˆæ¡ˆåç¨±}','{è²¼ä¸Šç”¨æˆ¶åŸå§‹éœ€æ±‚}','{å¡«å¯«æ ¸å¿ƒç›®æ¨™}','{æ¨¡çµ„ 1}','{æ¨¡çµ„ 2}'];
  const found=placeholders.filter(p=>draftMarkdown.includes(p));
  if(found.length>0)fail('å­˜åœ¨ä½”ä½ç¬¦: '+found.join(', '));else pass('ç„¡ä½”ä½ç¬¦');

  return checks;
}

function renderValidation(){
  if(!draftMarkdown){document.getElementById('valOutput').innerHTML='<p style="color:#64748b">å°šç„¡ Draft å¯é©—è­‰</p>';return;}
  const d=parseDraft(draftMarkdown);
  const checks=validateDraft(d);
  const fails=checks.filter(c=>c.level==='fail').length;
  const warns=checks.filter(c=>c.level==='warn').length;
  const passes=checks.filter(c=>c.level==='pass').length;
  const icon={pass:'âœ…',warn:'âš ï¸',fail:'âŒ'};
  let html=`<h3 style="color:#38bdf8;margin-bottom:12px">ğŸ“ Enhanced Draft é©—è­‰å ±å‘Š</h3>`;
  html+=`<p style="margin-bottom:12px">${fails===0?'<span style="color:#86efac">âœ… PASS</span>':'<span style="color:#f87171">âŒ FAIL</span>'}</p>`;
  for(const c of checks)html+=`<div class="vr ${c.level}">${icon[c.level]} ${esc(c.msg)}</div>`;
  html+=`<p style="margin-top:12px;color:#94a3b8">ğŸ“Š ${passes} pass | ${warns} warn | ${fails} fail</p>`;
  document.getElementById('valOutput').innerHTML=html;
}

// ============================================
// UPDATE PREVIEW
// ============================================
function updatePreview(){
  if(!draftMarkdown)return;
  // Parse and render viz
  const d=parseDraft(draftMarkdown);
  document.getElementById('emptyState').style.display='none';
  document.getElementById('vizContent').style.display='block';
  document.getElementById('vizContent').innerHTML=renderViz(d);
  // Update markdown tab
  document.getElementById('mdOutput').textContent=draftMarkdown;
  // Update validation tab
  renderValidation();
}

// ============================================
// EXPORT
// ============================================
function exportMD(){
  if(!draftMarkdown){alert('å°šç„¡ Draft å¯åŒ¯å‡º');return;}
  const blob=new Blob([draftMarkdown],{type:'text/markdown;charset=utf-8'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='requirement_draft_iter-1.md';
  a.click();
}

function exportHTML(){
  if(!draftMarkdown){alert('å°šç„¡ Draft å¯åŒ¯å‡º');return;}
  const d=parseDraft(draftMarkdown);
  const vizHTML=renderViz(d);
  const fullHTML=`<!DOCTYPE html><html lang="zh-TW"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>ğŸ“ ${esc(d.title||'Blueprint')}</title>
<style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',system-ui,sans-serif;background:#0f172a;color:#e2e8f0;padding:20px;max-width:1100px;margin:0 auto;line-height:1.6}
${document.querySelectorAll('style')[2]?.textContent||''}
</style></head><body>${vizHTML}<footer style="text-align:center;padding:24px;color:#475569;font-size:.8rem">SDID Blueprint Studio | ${new Date().toISOString().split('T')[0]}</footer></body></html>`;
  const blob=new Blob([fullHTML],{type:'text/html;charset=utf-8'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=(d.title||'blueprint')+'-viz.html';
  a.click();
}

// ============================================
// RESET
// ============================================
function resetAll(){
  if(!confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰å°è©±ï¼Ÿ'))return;
  messages=[];currentRound=1;draftMarkdown='';
  document.getElementById('chat').innerHTML='';
  document.getElementById('emptyState').style.display='flex';
  document.getElementById('vizContent').style.display='none';
  document.getElementById('mdOutput').textContent='';
  document.getElementById('valOutput').innerHTML='';
  document.getElementById('inp').placeholder=ROUNDS[0].hint;
  updateSteps();
}

// ============================================
// ALSO: Allow pasting a draft directly for preview
// ============================================
document.addEventListener('paste',e=>{
  // If pasting into the markdown pane area, parse it
  const active=document.activeElement;
  if(active&&active.id==='mdOutput'){
    e.preventDefault();
    const text=(e.clipboardData||window.clipboardData).getData('text');
    if(text.includes('Enhanced Blueprint Draft')||text.includes('æ¨¡çµ„åŒ–è¨­è¨ˆè—åœ–')){
      draftMarkdown=text;
      updatePreview();
      addMsg('system','ğŸ“‹ å·²å¾å‰ªè²¼ç°¿è¼‰å…¥ Draftï¼Œé è¦½å·²æ›´æ–°');
    }
  }
});

// Init
updateSteps();
</script>
</body>
</html>
